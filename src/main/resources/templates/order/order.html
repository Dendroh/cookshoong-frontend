<!DOCTYPE html>
<html data-bs-theme="light" lang="en" data-bss-forced-theme="light"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{config}">
<head>
    <title>Order</title>
</head>

<body layout:fragment="content">
<header th:replace="fragments :: mypage-site-header"></header>
<div th:replace="fragments :: business-store-list"></div>
<div th:replace="fragments :: all-address-list"></div>

<div class="container-fluid page-body-wrapper">
    <nav th:replace="fragments :: mypage-site-nav"></nav>
    <div class="main-panel">
        <div class="content-wrapper">
            <div class="row">
                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="font-weight-bold">주문</h1>
                        </div>
                    </div>
                </div>

                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <div class="row justify-content-between mb-3">
                                <h4 class="card-title" th:text="${storeName}"></h4>
                            </div>
                            <div class="col-12 grid-margin" th:each="item, i:${cartItems}" th:unless="${item == null}">
                                <div class="row border-top pb-1 pt-3 justify-content-between" >
                                    <div class="pt-1">
                                        <span class="font-weight-bold" th:utext="${item.menuOptName}" style="font-size: 1.2rem"></span>
                                    </div>
                                    <div class="text-right">
                                        <form th:action="@{/carts/menu-delete/{menuKey}(menuKey=${item.hashKey})}" th:method="DELETE" class="mb-3 mr-2">
                                            <button class="btn m-0 p-0" style="color: #000000" type="submit">
                                                <i class="mdi mdi-close"></i>
                                            </button>
                                        </form>
                                        <span class="p-2 font-weight-bold" th:text="${#numbers.formatInteger(item.totalMenuPrice,3,'COMMA')}+'원'" style="font-size: 1.1rem">
                                        </span>
                                    </div>
                                </div>
                                <div class="row pb-1 pt-1 justify-content-between" >

                                    <div class="border-info" style="max-width: 200px"
                                         th:onclick="'window.location.href=\'/index/store/' + ${item.storeId} + '\''">
                                        <img style="border-radius: 3px; object-fit: cover; width: 100px; height: 100px;" th:src="${item.menu.menuImage}"
                                             onerror="this.onerror=null; this.src='/assets/images/nodata.png';">
                                    </div>
                                    <div class="text-right">
                                        <div class="mb-3">
                                            <span class="menu-count" th:text="${item.count} + 'EA'"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <div class="row justify-content-between mb-2">
                                <h4 class="card-title" th:text="'배달 주소'"></h4>
                            </div>
                            <div class="p-3">
                                <h4 id="mainPlace" style="font-size:1.3rem;" class="font-weight-bold ml-0 mb-0 mt-2" th:text="${mainPlace}"></h4>
                                <input id="detailPlace" type="text" style="font-size:1.3rem;" class="font-weight-bold ml-0 mb-0 mt-2" th:value="${detailPlace}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <div class="row justify-content-between mb-2">
                                <h4 class="card-title" th:text="'요청사항'"></h4>
                            </div>
                            <div class="p-3">
                                <textarea id="memo" type="text" style="font-size:1.3rem;" class="font-weight-bold ml-0 mb-0 mt-2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="couponButton" th:storeId="${storeId}" th:totalPrice = "${totalPrice}" th:onclick="openCoupon(this.getAttribute('storeId'), this.getAttribute('totalPrice'))">쿠폰 선택하기</button>

                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <div class="row justify-content-between mb-2">
                                <h4 class="card-title" th:text="'총 주문 금액'"></h4>
                            </div>
                            <div class="d-flex justify-content-between p-3">
                                <h4 style="font-size:1.3rem;" class="font-weight-bold ml-0 mb-0 mt-2" th:text="(${totalPrice} != null ? ${#numbers.formatInteger(totalPrice, 3, 'COMMA')} : '0') + '원'"></h4>
                                <p>Coupon Discount: <span id="discountValue"></span></p>

                                <div class="d-flex justify-content-center">
                                    <form id="paymentForm" th:action="@{/payments}" method="post">
                                        <button id="orderButton" class="btn" th:storeId="${storeId}" th:totalPrice="${totalPrice}" th:onclick="payment(this.getAttribute('storeId'), this.getAttribute('totalPrice'))" style="width: 150px; background: #ffa636" th:text="결제하기"></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="fragments :: site-footer"></footer>

<script th:inline="javascript">
    let couponCode = null;
    let discountPrice = null;
    function setCoupon(selectCouponCode, discount) {
        if (couponCode !== selectCouponCode) {
            couponCode = selectCouponCode;
            discountPrice = discount;
        } else {
            couponCode = null;
            discountPrice = null;
        }
        document.getElementById('discountValue').textContent = discountPrice;
    }

    function openCoupon(storeId, totalPrice) {
        window.open("/order/" + storeId + "/coupon" + "?totalPrice=" + totalPrice,"","width=700px,height=600px,top=200px,left=200px;");
    }

    function payment(storeId, totalPrice) {
        let price = totalPrice;

        if (discountPrice !== null) {
            price = discountPrice;
        }

        const mainPlace = document.getElementById("mainPlace").textContent;
        const detailPlace = document.getElementById("detailPlace").value;

        const memo = document.getElementById("memo").value;

        const hiddenInputStoreId = document.createElement("input");
        hiddenInputStoreId.type = "hidden";
        hiddenInputStoreId.name = "storeId";
        hiddenInputStoreId.value = storeId;
        document.getElementById("paymentForm").appendChild(hiddenInputStoreId);

        const hiddenInputPrice = document.createElement("input");
        hiddenInputPrice.type = "hidden";
        hiddenInputPrice.name = "price";
        hiddenInputPrice.value = price;
        document.getElementById("paymentForm").appendChild(hiddenInputPrice);

        const hiddenInputMainPlace = document.createElement("input");
        hiddenInputMainPlace.type = "hidden";
        hiddenInputMainPlace.name = "mainPlace";
        hiddenInputMainPlace.value = mainPlace;
        document.getElementById("paymentForm").appendChild(hiddenInputMainPlace);

        const hiddenInputDetailPlace = document.createElement("input");
        hiddenInputDetailPlace.type = "hidden";
        hiddenInputDetailPlace.name = "detailPlace";
        hiddenInputDetailPlace.value = detailPlace;
        document.getElementById("paymentForm").appendChild(hiddenInputDetailPlace);

        const hiddenInputMemo = document.createElement("input");
        hiddenInputMemo.type = "hidden";
        hiddenInputMemo.name = "memo";
        hiddenInputMemo.value = memo;
        document.getElementById("paymentForm").appendChild(hiddenInputMemo);

        const hiddenInputCouponCode = document.createElement("input");
        hiddenInputCouponCode.type = "hidden";
        hiddenInputCouponCode.name = "couponCode";
        hiddenInputCouponCode.value = couponCode;
        document.getElementById("paymentForm").appendChild(hiddenInputCouponCode);

        const hiddenInputPoint = document.createElement("input");
        hiddenInputPoint.type = "hidden";
        hiddenInputPoint.name = "point";
        hiddenInputPoint.value = "0";
        document.getElementById("paymentForm").appendChild(hiddenInputPoint);

        // 폼 제출
        document.getElementById("paymentForm").submit();
    }
</script>

</body>

</html>
