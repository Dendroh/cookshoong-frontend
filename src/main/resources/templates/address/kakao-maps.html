<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>회원 주소 등록</title>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=55b38bb80852c12b35f14456e76868a9&libraries=services"></script>
    <style>
        #map {
            width: 300px;
            height: 300px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        #currentLocationBtn {
            position: absolute;
            top: 83px;
            left: 10px;
            padding: 5px;
            background-color: white;
            border: 1px solid black;
            z-index: 1;
        }
    </style>
</head>
<body>

<h1>주소 등록하기</h1>

<div id="map"></div>

<br>
<form th:action="@{${url}}" method="POST" id="addressForm" th:object="${address}">
    <tr>
        <td>
            <div>
                <input type="text" id="addressInput" name="mainPlace" th:field="*{mainPlace}" placeholder="주소" pattern="^[가-힇0-9\w\-\, ]+$" required>
                <input type="hidden" id="latitudeInput" name="latitude" th:field="*{latitude}">
                <input type="hidden" id="longitudeInput" name="longitude" th:field="*{longitude}">
                <input type="button" onclick="execDaumPostcode()" value="주소 검색">
                <br>
            </div>
            <div>
                <input type="text" id="alias" name="alias" th:field="*{alias}" placeholder="별칭" pattern="^[가-힇\w]+$" required>
            </div>
            <div>
                <input type="text" id="detailAddress" name="detailPlace" th:field="*{detailPlace}" placeholder="상세주소" pattern="^[가-힇0-9\w\-\, ]+$" required>
            </div>
    </tr>
    <br>
    <input type="submit" value="주소와 좌표 저장" onclick="return validateAddress()">
    <div id="addressError" class="error-message"></div> <!-- 오류 메시지를 표시할 요소 -->
</form>

<table>
    <thead>
    <tr>
        <th>별칭</th>
        <th>메인 주소</th>
    </tr>
    </thead>
    <tbody id="addressTable">
        <tr th:each="a : ${accountAddresses}">
            <td th:text="${a.getAlias()}">별칭</td>
            <td th:text="${a.getMainPlace()}">메인 주소</td>
            <td>
                <form th:action="@{/accounts/addresses/maps/{id}/select(id=${a.id})}" th:method="PATCH">
                    <input type="submit" th:value="선택">
                </form>
            </td>
            <td>
                <form th:action="@{/accounts/addresses/maps/{id}/delete(id=${a.id})}" id="deleteForm" th:method="DELETE" onsubmit="return confirm('정말로 삭제하시겠습니까?')">
                    <input type="submit" th:value="삭제" th:onclick="return deleteAddress()" onclick="return deleteAddress()">
                </form>
            </td>
        </tr>
    </tbody>
</table>

<script th:inline="javascript">

    var latitude = [[${latitude}]];
    var longitude = [[${longitude}]];

    var mapContainer = document.getElementById('map');
    var mapOption = {
        center: new kakao.maps.LatLng(latitude, longitude),
        level: 5
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var geocoder = new kakao.maps.services.Geocoder();
    var marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(latitude, longitude),
        map: map
    });

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        searchDetailAddrFromCoords(mouseEvent.latLng, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                // 주소 정보를 가져와서 필요한 처리를 수행.
                var address = result[0].address.address_name;
                var latitude = mouseEvent.latLng.getLat();
                var longitude = mouseEvent.latLng.getLng();

                document.getElementById('addressInput').value = address;
                document.getElementById('latitudeInput').value = latitude;
                document.getElementById('longitudeInput').value = longitude;

                // 마커를 클릭한 위치에 표시.
                marker.setPosition(mouseEvent.latLng);
                marker.setMap(map);
            }
        });
    });

    function searchDetailAddrFromCoords(coords, callback) {
        // 좌표로 법정동 상세 주소 정보를 요청합니다
        geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
    }

    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                // 선택한 주소 정보를 가져와서 필요한 처리를 수행.
                var address = data.address;
                document.getElementById("addressInput").value = address;

                // 주소로 좌표를 반환하여 지도에 표시.
                geocoder.addressSearch(address, function(results, status) {
                    if (status === daum.maps.services.Status.OK) {
                        var result = results[0];
                        var lat = result.y;
                        var lng = result.x;

                        document.getElementById("latitudeInput").value = lat;
                        document.getElementById("longitudeInput").value = lng;

                        // 지도의 중심을 선택한 주소 위치로 이동.
                        var moveLatLon = new kakao.maps.LatLng(lat, lng);
                        map.setCenter(moveLatLon);
                        marker.setPosition(moveLatLon);
                        marker.setMap(map);
                    }
                });
            }
        }).open();
    }

    function validateAddress() {

        // 주소록 개수 체크
        return checkAddressLimit();
    }

    function  deleteAddress() {

        return checkedAddressMinLimit();
    }

    function checkAddressLimit() {
        // 주소록 테이블의 행 개수 확인
        var addressRowCount = document.querySelectorAll('#addressTable tr').length;

        // 저장 버튼 가져오기
        var saveButton = document.querySelector('#addressForm input[type="submit"]');

        // 주소록 행 개수가 10개 이상인 경우 에러 메시지 표시 및 저장 버튼 비활성화
        if (addressRowCount > 9) {
            var addressError = document.getElementById("addressError");
            addressError.innerText = "회원이 가지고 있는 주소가 10개가 넘었습니다. 주소 삭제 바랍니다.";
            saveButton.disabled = true;
            return false;
        }
        return true;
    }

    function  checkedAddressMinLimit() {

        // 주소록 테이블의 행 개수 확인
        var addressRowCount = document.querySelectorAll('#addressTable tr').length;

        // 저장 버튼 가져오기
        var deleteButton = document.querySelector('#deleteForm input[type="submit"]');

        if (addressRowCount < 2) {
            var addressError = document.getElementById("addressError");
            addressError.innerText = "주소는 최대 하나 이상은 가지고 있어야 합니다.";
            deleteButton.disabled = true;
            return false;
        }

        return true;
    }


    // 현재 위치 가져오기 버튼 생성
    var currentLocationBtn = document.createElement('button');
    currentLocationBtn.innerHTML = '현재 위치 가져오기';
    currentLocationBtn.id = 'currentLocationBtn';

    currentLocationBtn.onclick = function() {
        getCurrentLocation();
    };

    document.body.appendChild(currentLocationBtn);

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                var locPosition = new kakao.maps.LatLng(lat, lng);

                // 현재 위치로 맵 중심 좌표 변경
                map.setCenter(locPosition);

                // 마커 위치 변경
                marker.setPosition(locPosition);
                marker.setMap(map);

                // 현재 위치를 주소로 변환하여 주소 입력 필드에 표시
                geocoder.coord2Address(lng, lat, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        document.getElementById("addressInput").value = result[0].address.address_name;
                    }
                });

                // 현재 위치를 좌표로 입력 필드에 설정
                document.getElementById("latitudeInput").value = lat;
                document.getElementById("longitudeInput").value = lng;
            });
        } else {
            alert('위치 정보를 가져올 수 없습니다.');
        }
    }
</script>
</body>
</html>
